<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no">
    <title>MSFXP 服务器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2196F3;
            --secondary-color: #03A9F4;
            --accent-color: #00BCD4;
            --dark-color: #333;
            --light-color: #f9f9f9;
            --gradient-bg: linear-gradient(135deg, #0c2646 0%, #204065 50%, #2a5788 100%);
            --primary-color-rgb: 33, 150, 243;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            min-height: 100vh;
            margin: 0;
            background: var(--gradient-bg);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            font-family: 'Arial', sans-serif;
            color: #fff;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.03);
            pointer-events: none;
        }
        
        .header {
            width: 100%;
            padding: 20px 0;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        
        h1 {
            font-size: 2.5rem;
            margin: 0;
            background: linear-gradient(to right, var(--accent-color), var(--primary-color));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .container {
            width: 90%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.03);
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            margin: 40px 0;
            border: 1px solid rgba(255, 255, 255, 0.15);
            position: relative;
            z-index: 1;
            overflow: hidden;
        }
        
        /* 为不支持backdrop-filter的浏览器提供备选样式 */
        @supports not (backdrop-filter: blur(10px)) {
            .container {
                background: rgba(12, 38, 70, 0.7);
            }
        }
        
        .container::before {
            display: none;
        }
        
        h2 {
            color: var(--accent-color);
            margin-bottom: 15px;
            position: relative;
            padding-bottom: 10px;
        }
        
        h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px;
        }
        
        p {
            line-height: 1.6;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .server-status {
            margin: 30px 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: center;
            position: relative;
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            flex-direction: column;
        }
        
        .server-status::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            z-index: 1;
        }
        
        .motd-container {
            width: 100%;
            max-width: 100%;
            min-height: 265px;
            border: none;
            display: flex;
            flex-direction: column;
            color: white;
        }
        
        .motd-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .motd-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
            color: var(--accent-color);
        }
        
        .motd-address {
            font-size: 1rem;
            margin: 5px 0 15px 0;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .motd-version {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 20px;
        }
        
        .motd-button {
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .motd-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .motd-info-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .motd-info-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 15px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            transition: background 0.3s ease;
        }
        
        .motd-info-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .motd-info-item i {
            margin-right: 15px;
            color: var(--accent-color);
            width: 20px;
            text-align: center;
        }
        
        .motd-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }
        
        .motd-loading i {
            font-size: 2rem;
            color: var(--accent-color);
            margin-bottom: 15px;
        }
        
        .motd-error {
            color: #ff5252;
            text-align: center;
            margin-top: 10px;
        }
        
        .motd-status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .motd-online {
            background-color: #4CAF50;
        }
        
        .motd-offline {
            background-color: #ff5252;
        }
        
        .action-button {
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.2rem;
            margin-top: 30px;
            display: inline-block;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        .action-button:hover::before {
            left: 100%;
        }
        
        .action-button i {
            margin-right: 10px;
        }
        
        .footer {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            padding: 20px 0;
            margin-top: auto;
            backdrop-filter: blur(10px);
        }
        
        .footer a {
            color: var(--accent-color);
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer a:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .container {
                width: 95%;
                padding: 20px;
            }
            
            .action-button {
                width: 100%;
                font-size: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            .server-status iframe {
                height: 240px;
            }
        }
        
        .server-selectors {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .server-selector {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .server-selector:hover, .server-selector.active {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .server-selector.active {
            border-color: var(--accent-color);
        }
        
        /* 服务器选择对话框样式 */
        .server-select-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .server-select-content {
            background-color: rgba(20, 50, 80, 0.95);
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }
        
        .server-select-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .server-select-header h3 {
            margin: 0;
            color: white;
        }
        
        .close-dialog {
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .close-dialog:hover {
            color: var(--accent-color);
        }
        
        .server-select-body {
            padding: 20px;
            color: white;
        }
        
        .server-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        
        .server-option {
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .server-option:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .server-option.recommended {
            background-color: rgba(var(--primary-color-rgb), 0.15);
            border-color: rgba(var(--primary-color-rgb), 0.3);
        }
        
        .server-option-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .server-option-address {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }
        
        .server-option-delay {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85em;
            margin-top: 3px;
        }
        
        .recommended-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--accent-color);
            color: white;
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 20px;
        }
        
        .ipv6-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #8e44ad;
            color: white;
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 20px;
        }
        
        .ipv6-notice {
            margin-top: 8px;
            color: #f39c12;
            font-size: 0.85em;
        }
        
        .server-option.ipv6 {
            border-color: rgba(142, 68, 173, 0.3);
        }
        
        .server-option.offline {
            opacity: 0.7;
            border-color: rgba(255, 77, 77, 0.3);
        }
        
        .server-option-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-top: 5px;
        }
        
        .server-option-status.online {
            background-color: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .server-option-status.offline {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        /* 快速操作按钮样式 */
        .quick-actions {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .quick-action-button {
            padding: 12px 20px;
            border-radius: 50px;
            text-decoration: none;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 200px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .quick-action-button i {
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        .quick-action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }
        
        .download-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .qq-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
        
        @media (max-width: 480px) {
            .quick-actions {
                flex-direction: column;
            }
            
            .quick-action-button {
                width: 100%;
            }
        }
        
        /* 版本选择对话框 */
        .download-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .download-dialog-content {
            background-color: rgba(20, 50, 80, 0.95);
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }
        
        .download-dialog-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .download-dialog-header h3 {
            margin: 0;
            color: white;
        }
        
        .download-dialog-body {
            padding: 20px;
            color: white;
        }
        
        .download-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        
        .download-option {
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
        }
        
        .download-option:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .download-option.recommended {
            background-color: rgba(var(--primary-color-rgb), 0.15);
            border-color: rgba(var(--primary-color-rgb), 0.3);
        }
        
        .download-option-icon {
            font-size: 24px;
            margin-right: 15px;
            color: var(--accent-color);
        }
        
        .download-option-info {
            flex-grow: 1;
        }
        
        .download-option-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .download-option-desc {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>MSFXP 服务器</h1>
    </div>
    
    <div class="container">
        <h2>嘿！这里是MSFXP</h2>
        <p>MSFXP是一个生存服务器，里面有形形色色的玩家们，服务器玩法有怪物强化，装备强化，枪械，妖精女仆等~~ <br>此外，我们还有各位生电服的大佬（划掉）坐镇，欢迎大家的加入！</p>
        
        <div class="quick-actions">
            <a href="javascript:void(0);" onclick="showDownloadOptions()" class="quick-action-button download-btn">
                <i class="fas fa-download"></i>下载Minecraft 1.20.15
            </a>
            <a href="https://qq.msfxp.top" class="quick-action-button qq-btn">
                <i class="fas fa-users"></i>加入QQ群
            </a>
        </div>
        
        <h2>服务器状态</h2>
        <div class="server-status">
            <div id="motdContainer" class="motd-container">
                <div class="motd-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div>正在连接服务器...</div>
                </div>
            </div>
        </div>
        
        <button class="action-button" onclick="connectToServer()">
            <i class="fas fa-user-circle"></i>打开个人中心
        </button>
    </div>
    
    <div class="footer">
        <div>Power By MSFXP</div>
        <div style="margin-top: 5px; font-size: 0.8rem;">© 2025 MSFXP</div>
    </div>

    <script src="activity.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const servers = [
                {
                    name: "主要IP",
                    ip: "msfxp.ucket.my",
                    port: "19125",
                    delay: 999,
                    status: "unknown"
                },
                {
                    name: "备用IP",
                    ip: "frp-gap.com",
                    port: "23236",
                    delay: 999,
                    status: "unknown"
                },
                {
                    name: "备用IP",
                    ip: "frp.msfxp.top",
                    port: "19132",
                    delay: 999,
                    status: "unknown"
                }
            ];
            
            // 使服务器数据全局可访问
            window.servers = servers;
            
            let currentServerIndex = 0;
            
            const motdContainer = document.getElementById('motdContainer');
            
            motdContainer.innerHTML = `
                <div class="motd-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div>正在连接服务器...</div>
                </div>
            `;
            
            // 同时获取所有服务器的状态
            fetchAllServersStatus();
            
            // 设置定时刷新
            setInterval(fetchAllServersStatus, 60000);
            
            // 同时获取所有服务器的状态
            function fetchAllServersStatus() {
                // 重置服务器状态
                servers.forEach(server => {
                    server.status = "unknown";
                });
                
                // 获取全部服务器的状态
                const fetchPromises = servers.map((server, index) => {
                    const serverAddress = `${server.ip}:${server.port}`;
                    const apiUrl = `https://motdbe.blackbe.work/api?host=${serverAddress}`;
                    
                    return fetch(apiUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('网络响应错误');
                            }
                            return response.json();
                        })
                        .then(data => {
                            servers[index].delay = data.delay || 999;
                            servers[index].status = "online";
                            servers[index].data = data;
                            return data;
                        })
                        .catch(error => {
                            console.error(`获取服务器 ${serverAddress} 状态失败:`, error);
                            servers[index].delay = 999;
                            servers[index].status = "offline";
                            return null;
                        });
                });
                
                // 等待所有请求完成
                Promise.all(fetchPromises).then(() => {
                    // 查找延迟最低的在线服务器
                    let lowestDelayIndex = -1;
                    let lowestDelay = 999999;
                    
                    for (let i = 0; i < servers.length; i++) {
                        if (servers[i].status === "online" && servers[i].delay < lowestDelay) {
                            lowestDelay = servers[i].delay;
                            lowestDelayIndex = i;
                        }
                    }
                    
                    // 如果找到在线服务器，显示延迟最低的
                    if (lowestDelayIndex >= 0) {
                        currentServerIndex = lowestDelayIndex;
                        updateMotdDisplay(servers[lowestDelayIndex].data, servers[lowestDelayIndex], servers);
                    } else {
                        // 如果所有服务器都离线，显示离线状态
                        displayOfflineStatus(servers[0]);
                    }
                });
            }
            
            window.switchServer = function(index) {
                if (index >= 0 && index < servers.length) {
                    currentServerIndex = index;
                    
                    if (servers[index].status === "online" && servers[index].data) {
                        // 如果已经有数据，直接显示
                        updateMotdDisplay(servers[index].data, servers[index], servers);
                    } else if (servers[index].status === "offline") {
                        // 如果已知离线，显示离线状态
                        displayOfflineStatus(servers[index]);
                    } else {
                        // 如果状态未知，重新获取
                        const serverAddress = `${servers[index].ip}:${servers[index].port}`;
                        const apiUrl = `https://motdbe.blackbe.work/api?host=${serverAddress}`;
                        
                        // 显示加载状态
                        motdContainer.innerHTML = `
                            <div class="motd-loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <div>正在连接服务器...</div>
                            </div>
                        `;
                        
                        fetch(apiUrl)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('网络响应错误');
                                }
                                return response.json();
                            })
                            .then(data => {
                                servers[index].delay = data.delay || 999;
                                servers[index].status = "online";
                                servers[index].data = data;
                                updateMotdDisplay(data, servers[index], servers);
                            })
                            .catch(error => {
                                console.error(`获取服务器 ${serverAddress} 状态失败:`, error);
                                servers[index].delay = 999;
                                servers[index].status = "offline";
                                displayOfflineStatus(servers[index]);
                            });
                    }
                }
            };
        });
        
        function updateMotdDisplay(data, currentServer, allServers) {
            const motdContainer = document.getElementById('motdContainer');
            
            if (!data || data.status !== "online") {
                displayOfflineStatus(currentServer);
                return;
            }
            
            let cleanMotd = data.motd || "MSFXP Survival";
            cleanMotd = cleanMotd.replace(/§[0-9a-fklmnor]/gi, '');
            
            let serverSelectorsHtml = '';
            allServers.forEach((server, index) => {
                if (server.isIpv6) return;
                
                const isActive = server.ip === currentServer.ip && server.port === currentServer.port;
                const statusClass = server.status === "online" ? "online" : (server.status === "offline" ? "offline" : "");
                serverSelectorsHtml += `
                    <button class="server-selector ${isActive ? 'active' : ''} ${statusClass}" 
                            onclick="switchServer(${index})" 
                            data-server-info='{"index": ${index}, "delay": ${server.delay || 999}, "status": "${server.status}"}'>
                        ${server.name}
                    </button>
                `;
            });
            
            motdContainer.innerHTML = `
                <div class="motd-header">
                    <h2 class="motd-title"><span class="motd-status-indicator motd-online"></span>${cleanMotd}</h2>
                </div>
                
                <div class="server-selectors">
                    ${serverSelectorsHtml}
                </div>
                
                <div class="motd-address">${data.host}</div>
                <div class="motd-version">MCBE: ${data.version || "1.20.15"} | Protocol: ${data.agreement || "未知"}</div>
                
                <button class="motd-button" onclick="joinServer(${allServers.indexOf(currentServer)})">加入服务器</button>
                
                <div class="motd-info-grid">
                    <div class="motd-info-item">
                        <i class="fas fa-gamepad"></i>
                        <span>游戏模式: ${data.gamemode || "Survival"}</span>
                    </div>
                    <div class="motd-info-item">
                        <i class="fas fa-users"></i>
                        <span>在线人数: ${data.online} / ${data.max}</span>
                    </div>
                    <div class="motd-info-item">
                        <i class="fas fa-map"></i>
                        <span>地图名: ${data.level_name || cleanMotd}</span>
                    </div>
                    <div class="motd-info-item">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>延迟: ${data.delay || "-"} ms</span>
                    </div>
                </div>
            `;
        }
        
        function joinServer(serverIndex = 0) {
            // 使用页面上已加载的服务器数据
            const mainServers = document.querySelectorAll('[data-server-info]');
            const servers = [
                {
                    name: "主要IP",
                    server_name: "§b§lMSFXP",
                    ip: "msfxp.ucket.my",
                    port: "19125",
                    delay: 999
                },
                {
                    name: "备用IP",
                    server_name: "§b§lMSFXP",
                    ip: "frp-gap.com",
                    port: "23236",
                    delay: 999
                },
                {
                    name: "备用IP",
                    server_name: "§b§lMSFXP",
                    ip: "frp.msfxp.top",
                    port: "19132",
                    delay: 999
                },
                {
                    name: "IPv6",
                    server_name: "§b§lMSFXP",
                    ip: "msfxp-ipv6.ucket.my",
                    port: "19133",
                    isIpv6: true,
                    delay: 999
                }
            ];
            
            // 同步全局服务器状态中的延迟数据
            try {
                const parentScope = window.parent || window;
                if (parentScope.document) {
                    if (typeof parentScope.servers !== 'undefined') {
                        // 可以从上面的全局变量中获取服务器数据
                        for (let i = 0; i < Math.min(3, parentScope.servers.length); i++) {
                            if (parentScope.servers[i].status === 'online') {
                                servers[i].delay = parentScope.servers[i].delay || 999;
                                servers[i].status = 'online';
                            } else {
                                servers[i].delay = 999;
                                servers[i].status = 'offline';
                            }
                        }
                    }
                }
            } catch (e) {
                console.error('获取服务器数据失败', e);
                
                // 备用方法：从DOM中获取主页面已经存在的服务器延迟数据
                try {
                    const delayElements = document.querySelectorAll('.motd-info-item .fa-tachometer-alt');
                    if (delayElements.length > 0) {
                        const delayText = delayElements[0].nextElementSibling.textContent;
                        const delayMatch = delayText.match(/(\d+)/);
                        if (delayMatch && delayMatch[1]) {
                            const currentDelay = parseInt(delayMatch[1]);
                            // 更新当前显示服务器的延迟
                            servers[serverIndex].delay = currentDelay;
                            servers[serverIndex].status = 'online';
                        }
                    }
                } catch (e) {
                    console.error('获取延迟数据失败', e);
                }
            }
            
            // 查找延迟最低的非IPv6服务器
            let lowestDelayIndex = 0;
            let lowestDelay = 999999;
            
            for (let i = 0; i < 3; i++) { // 只考虑前3个非IPv6服务器
                if (servers[i].status !== 'offline' && servers[i].delay < lowestDelay) {
                    lowestDelay = servers[i].delay;
                    lowestDelayIndex = i;
                }
            }
            
            // 如果所有服务器都离线，使用当前显示的服务器
            if (lowestDelay === 999999) {
                lowestDelayIndex = serverIndex;
            }
            
            let dialogHTML = `
                <div id="serverSelectDialog" class="server-select-dialog">
                    <div class="server-select-content">
                        <div class="server-select-header">
                            <h3>选择服务器IP</h3>
                            <span class="close-dialog" onclick="closeServerDialog()">&times;</span>
                        </div>
                        <div class="server-select-body">
                            <p>请选择要加入的服务器IP：</p>
                            <div class="server-options">`;
            
            servers.forEach((server, idx) => {
                const ipv6Badge = server.isIpv6 ? '<div class="ipv6-badge">IPv6</div>' : '';
                const ipv6Notice = server.isIpv6 ? '<div class="ipv6-notice"><i class="fas fa-info-circle"></i> 需要网络支持IPv6才能连接</div>' : '';
                const isRecommended = idx === lowestDelayIndex && !server.isIpv6;
                const delayInfo = server.delay < 999 ? `<div class="server-option-delay">延迟: ${server.delay} ms</div>` : '';
                const statusBadge = server.status === 'offline' ? 
                    '<div class="server-option-status offline">离线</div>' : 
                    (server.delay < 999 ? '<div class="server-option-status online">在线</div>' : '');
                
                dialogHTML += `
                    <div class="server-option ${isRecommended ? 'recommended' : ''} ${server.isIpv6 ? 'ipv6' : ''} ${server.status === 'offline' ? 'offline' : ''}" 
                         onclick="connectToMinecraft('${server.server_name}', '${server.ip}', '${server.port}')">
                        <div class="server-option-name">${server.name} ${isRecommended ? '(推荐)' : ''}</div>
                        <div class="server-option-address">${server.ip}:${server.port}</div>
                        ${statusBadge}
                        ${delayInfo}
                        ${isRecommended ? '<div class="recommended-badge">延迟最低</div>' : ''}
                        ${ipv6Badge}
                        ${ipv6Notice}
                    </div>
                `;
            });
            
            dialogHTML += `
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const dialogContainer = document.createElement('div');
            dialogContainer.id = 'serverDialogContainer';
            dialogContainer.innerHTML = dialogHTML;
            document.body.appendChild(dialogContainer);
            
            window.closeServerDialog = function() {
                const dialog = document.getElementById('serverDialogContainer');
                if (dialog) {
                    document.body.removeChild(dialog);
                }
            };
            
            window.connectToMinecraft = function(serverName, serverIP, serverPort) {
                const minecraftLink = `minecraft://?addExternalServer=${serverName}|${serverIP}:${serverPort}`;
                const deviceInfo = detectDevice();
                
                const startTime = Date.now();
                window.location.href = minecraftLink;
                
                // 设置一个超时，如果超过一定时间仍在当前页面，可能是应用未安装
                setTimeout(function() {
                    if (Date.now() - startTime < 1500) {
                        if (confirm("看起来您可能没有安装Minecraft或无法自动启动。\n是否需要下载Minecraft 1.20.15？")) {
                            showDownloadOptions();
                        } else {
                            alert(`如果Minecraft没有自动打开，您可以手动添加服务器。\nIP：${serverIP}\n端口：${serverPort}`);                            
                        }
                    }
                    
                    closeServerDialog();
                }, 1000);
            };
        }
        
        function displayOfflineStatus(server) {
            const motdContainer = document.getElementById('motdContainer');
            const serverAddress = server ? `${server.ip}:${server.port}` : "msfxp.ucket.my:19125";
            
            motdContainer.innerHTML = `
                <div class="motd-header">
                    <h2 class="motd-title"><span class="motd-status-indicator motd-offline"></span>服务器离线</h2>
                </div>
                <div class="motd-address">${serverAddress}</div>
                <div class="motd-error">服务器当前无法连接，请稍后再试或切换其他服务器ip</div>
                <div class="server-selectors">
                    <button class="server-selector" onclick="switchServer(0)">主要IP</button>
                    <button class="server-selector" onclick="switchServer(1)">备用IP</button>
                    <button class="server-selector" onclick="switchServer(2)">备用IP</button>
                </div>
                <button class="motd-button" onclick="location.reload()">刷新状态</button>
            `;
        }
        
        function connectToServer() {
            const personalCenterUrl = "https://msfxp-map.ucket.top";
            window.open(personalCenterUrl, "_blank");
        }
        
        function showDownloadOptions() {
            const downloadLinks = {
                android: "http://frp.msfxp.top/Minecraft/%5BAndroid%5D%20Minecraft_1.20.15.01.APK",
                ios: "http://frp.msfxp.top/Minecraft/%5BiOS%5D%20Minecraft_1.20.13.ipa",
                windows: "http://frp.msfxp.top/Minecraft/%5BWindows%5D%20MinecraftUWP_1.20.15.Appx"
            };
            
            // 自动检测设备类型
            const deviceInfo = detectDevice();
            let recommendedPlatform = "android"; // 默认推荐
            
            // 根据设备类型设置推荐平台
            if (deviceInfo.ios) {
                recommendedPlatform = "ios";
            } else if (deviceInfo.windows) {
                recommendedPlatform = "windows";
            }
            
            const dialogHTML = `
                <div id="downloadDialog" class="download-dialog">
                    <div class="download-dialog-content">
                        <div class="download-dialog-header">
                            <h3>选择下载版本</h3>
                            <span class="close-dialog" onclick="closeDownloadDialog()">&times;</span>
                        </div>
                        <div class="download-dialog-body">
                            <p>请选择适合您设备的Minecraft版本：</p>
                            <div class="download-options">
                                <div class="download-option ${recommendedPlatform === 'android' ? 'recommended' : ''}" onclick="downloadMinecraft('android')">
                                    <div class="download-option-icon"><i class="fab fa-android"></i></div>
                                    <div class="download-option-info">
                                        <div class="download-option-name">Android版</div>
                                        <div class="download-option-desc">Minecraft 1.20.15.01 APK</div>
                                    </div>
                                    ${recommendedPlatform === 'android' ? '<div class="recommended-badge">推荐</div>' : ''}
                                </div>
                                <div class="download-option ${recommendedPlatform === 'ios' ? 'recommended' : ''}" onclick="downloadMinecraft('ios')">
                                    <div class="download-option-icon"><i class="fab fa-apple"></i></div>
                                    <div class="download-option-info">
                                        <div class="download-option-name">iOS版</div>
                                        <div class="download-option-desc">Minecraft 1.20.13 IPA (需自签名安装)</div>
                                    </div>
                                    ${recommendedPlatform === 'ios' ? '<div class="recommended-badge">推荐</div>' : ''}
                                </div>
                                <div class="download-option ${recommendedPlatform === 'windows' ? 'recommended' : ''}" onclick="downloadMinecraft('windows')">
                                    <div class="download-option-icon"><i class="fab fa-windows"></i></div>
                                    <div class="download-option-info">
                                        <div class="download-option-name">Windows版</div>
                                        <div class="download-option-desc">Minecraft 1.20.15 UWP应用包</div>
                                    </div>
                                    ${recommendedPlatform === 'windows' ? '<div class="recommended-badge">推荐</div>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const dialogContainer = document.createElement('div');
            dialogContainer.id = 'downloadDialogContainer';
            dialogContainer.innerHTML = dialogHTML;
            document.body.appendChild(dialogContainer);
            
            window.closeDownloadDialog = function() {
                const dialog = document.getElementById('downloadDialogContainer');
                if (dialog) {
                    document.body.removeChild(dialog);
                }
            };
            
            window.downloadMinecraft = function(platform) {
                if (downloadLinks[platform]) {
                    window.open(downloadLinks[platform], '_blank');
                    closeDownloadDialog();
                }
            };
        }
        
        // 检测用户设备类型
        function detectDevice() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            
            // 设备信息对象
            const deviceInfo = {
                mobile: false,
                ios: false,
                android: false,
                windows: false,
                mac: false
            };
            
            // 检测移动设备
            if (/android/i.test(userAgent)) {
                deviceInfo.mobile = true;
                deviceInfo.android = true;
            }
            
            // iOS设备检测
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                deviceInfo.mobile = true;
                deviceInfo.ios = true;
            }
            
            // Windows检测
            if (/Windows NT/.test(userAgent)) {
                deviceInfo.windows = true;
            }
            
            // Mac检测
            if (/Macintosh|MacIntel|MacPPC|Mac68K/.test(userAgent)) {
                deviceInfo.mac = true;
            }
            
            return deviceInfo;
        }
    </script>
</body>
</html>